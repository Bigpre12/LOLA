// LOLA Prisma Schema
// AI Creative Engine for Teams - Weavy Alternative

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// FlowForge Core Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  plan          Plan      @default(FREE)
  credits       Int       @default(100)
  preferences   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Subscription/pricing fields
  monthlyRunsLimit   Int      @default(50)
  monthlyRunsUsed    Int      @default(0)
  subscriptionEndsAt DateTime?

  accounts   Account[]
  sessions   Session[]
  runs       Run[]
  apiKeys    ApiKey[]
  webhooks   Webhook[]
  feedback   RunFeedback[]
  recipes    Recipe[]
  shareLinks ShareLink[]
}

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

model Template {
  id               String   @id @default(cuid())
  slug             String   @unique
  name             String
  category         Category
  description      String
  inputSchema      Json // { fields: [{ key, type, label, required }] }
  optionsSchema    Json // { fields: [{ key, type, label, default, min?, max? }] }
  modelPipeline    Json // { steps: [{ id, type, model, promptTemplate }] }
  estimatedCredits Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Pricing transparency
  costPerRun Float @default(0.50) // Approximate cost in USD

  // Analytics fields
  totalRuns   Int   @default(0)
  successRate Float @default(100)
  avgRating   Float @default(0)
  totalRatings Int  @default(0)

  // Versioning for power users
  version     Int    @default(1)
  isPublic    Boolean @default(true)
  authorId    String?

  runs     Run[]
  feedback RunFeedback[]
  recipes  Recipe[]
}

enum Category {
  ECOMMERCE
  ADS
  BRAND
}

model Run {
  id         String    @id @default(cuid())
  userId     String
  templateId String
  status     RunStatus @default(QUEUED)
  inputs     Json
  options    Json
  outputs    Json? // [{ stepId, url, meta: { prompt } }]
  error      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Performance tracking
  durationMs    Int?
  creditsUsed   Int?
  modelProvider String?

  // API tracking
  apiKeyId String?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  template   Template    @relation(fields: [templateId], references: [id])
  feedback   RunFeedback?
  shareLinks ShareLink[]
}

enum RunStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

// Feedback/Evals System
model RunFeedback {
  id        String   @id @default(cuid())
  runId     String   @unique
  userId    String
  templateId String
  
  // Core feedback
  rating    Int // 1-5 stars
  hitTheMark Boolean // "Did this output hit what you needed?"
  
  // Optional detailed feedback
  feedback  String? // Free text feedback
  issues    String[] // Array of issue tags: ["wrong_style", "low_quality", "missing_element"]
  
  createdAt DateTime @default(now())

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  template Template @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([userId])
}

// API & Webhooks for Power Users
model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  key         String   @unique // hashed
  keyPreview  String   // last 4 chars for display
  permissions String[] @default(["read", "run"])
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
}

model Webhook {
  id        String   @id @default(cuid())
  userId    String
  name      String
  url       String
  secret    String   // for signature verification
  events    String[] // ["run.completed", "run.failed"]
  isActive  Boolean  @default(true)
  lastError String?
  lastTriggeredAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Saved Recipes (frozen pipeline + parameters)
model Recipe {
  id          String   @id @default(cuid())
  userId      String
  templateId  String
  name        String
  description String?
  
  // Frozen parameters
  inputs      Json     // Saved input values (excluding images)
  options     Json     // Saved option values
  
  // Metadata
  timesUsed   Int      @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  template Template @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([templateId])
}

// Shareable Links for Client Mode
model ShareLink {
  id        String   @id @default(cuid())
  runId     String
  userId    String
  token     String   @unique // unique share token
  
  // Access controls
  allowDownload  Boolean  @default(true)
  allowComments  Boolean  @default(true)
  requiresEmail  Boolean  @default(false) // Collect email before viewing
  password       String?  // Optional password protection
  
  // Expiration
  expiresAt DateTime?
  maxViews  Int?
  viewCount Int      @default(0)
  
  // Metadata
  createdAt DateTime @default(now())
  lastViewedAt DateTime?

  run      Run         @relation(fields: [runId], references: [id], onDelete: Cascade)
  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments ShareComment[]

  @@index([token])
}

// Comments on shared runs
model ShareComment {
  id          String   @id @default(cuid())
  shareLinkId String
  
  // Commenter info (may not be registered user)
  authorName  String
  authorEmail String?
  
  // Comment content
  content     String
  assetId     String?  // Optional: comment on specific asset
  isResolved  Boolean  @default(false)
  
  createdAt   DateTime @default(now())

  shareLink ShareLink @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)
}
